<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hero of Habits - RPG Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body, .rpg-font { font-family: 'Press Start 2P', monospace, sans-serif; }
    .rpg-card { border: 3px solid #a78bfa; border-radius: 1rem; box-shadow: 0 2px 12px #8b5cf633; }
    .rpg-glow { box-shadow: 0 0 20px 4px #3b82f6cc, 0 0 0 2px #a78bfa; }
    .level-up { animation: levelup-pop 0.8s; }
    @keyframes levelup-pop {
      0% { transform: scale(1);}
      20% { transform: scale(1.2) rotate(-2deg);}
      60% { transform: scale(1.1);}
      100% { transform: scale(1);}
    }
    .rpg-xp-bar {
      background: linear-gradient(90deg, #4ade80, #6366f1 60%, #7c3aed);
      box-shadow: 0 0 6px #6366f1cc;
      transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
    }
    .rpg-avatar {
      width: 96px; height: 96px; background: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 12px #7c3aed77; position: relative;
      overflow: visible;
    }
    .pixel-avatar {
      width: 80px; height: 80px;
      image-rendering: pixelated;
      border-radius: 10px;
      border: 2px solid #6366f1;
      background: #fff;
      margin: auto;
      z-index: 1;
      position: relative;
      object-fit: cover;
    }
    .avatar-equip { position: absolute; z-index: 2; pointer-events:none;}
    .avatar-equip.hat { left: 50%; top: -16px; transform: translateX(-50%); }
    .avatar-equip.weapon { right: 0; bottom: 8px;}
    .avatar-equip.shield { left: 0; bottom: 8px;}
    .avatar-equip.pet { left: 50%; bottom: -18px; transform: translateX(-50%);}
    .avatar-bg { position:absolute; left:0; top:0; width:100%; height:100%; border-radius:50%; z-index:0; }
    
    /* Dark Toggle Position Fix */
    #dark-toggle-corner {
      position: fixed;
      top: 16px;
      right: 24px;
      z-index: 100;
    }
    #dark-toggle-corner button {
      width: 44px; height: 44px;
      border-radius: 50%;
      background: #e0e7ff;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px #a78bfa33;
      border: 2px solid #a78bfa;
    }
    html.dark #dark-toggle-corner button {
      background: #312e81;
    }
    html.dark #dark-toggle-corner button:hover {
      background: #4338ca;
    }
    #dark-toggle-corner button:hover {
      background: #c7d2fe;
      transform: scale(1.1);
    }
    @media (max-width: 600px) {
      #dark-toggle-corner { top: 8px; right: 6px; }
      #dark-toggle-corner button { width: 38px; height: 38px; }
    }
    
    /* Updated Avatar Customization Styles */
    .avatar-customizer {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      transition: all 0.3s ease;
    }
    .avatar-customizer.hidden {
      display: none;
    }
    .avatar-option {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      border: 2px solid #ddd;
      transition: all 0.2s;
    }
    .avatar-option.selected {
      border-color: #6366f1;
      transform: scale(1.1);
      box-shadow: 0 0 0 2px #6366f1;
    }
    .confirm-avatar-btn {
      margin-top: 8px;
      padding: 4px 12px;
      background: #6366f1;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      transition: all 0.2s;
    }
    .confirm-avatar-btn:hover {
      background: #4f46e5;
      transform: scale(1.05);
    }
    .customize-avatar-btn {
      margin-top: 8px;
      padding: 4px 12px;
      background: #818cf8;
      color: white;
      border-radius: 4px;
      font-size: 12px;
      transition: all 0.2s;
    }
    .customize-avatar-btn:hover {
      background: #6366f1;
      transform: scale(1.05);
    }

    .rpg-quest {
      background: linear-gradient(90deg, #fbbf24 40%, #f472b6 100%);
      color: #78350f;
      font-weight: bold;
      border-radius: 0.5rem;
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }
    .rpg-btn {
      border: 2px solid #a78bfa;
      box-shadow: 0 1px 4px #a78bfa22;
      min-width: 7.5rem;
      text-align: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    .rpg-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px #a78bfa44;
    }
    .rpg-btn.active {
      background: #6366f1 !important;
      color: white !important;
      border-color: #4f46e5;
    }
    .confetti {
      pointer-events: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh; z-index: 1001;
      display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start;
      overflow: hidden;
    }
    .confetti-piece {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      opacity: 0.8;
      position: absolute;
      will-change: transform, opacity;
      animation: confetti-fall 1.2s linear forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1;}
      80% { opacity: 1;}
      100% { transform: translateY(600px) rotate(360deg) scale(0.8); opacity: 0;}
    }
    .spa-section { display: none; }
    .spa-section.active { display: block; }
    .achievement-locked { opacity: 0.3; filter: grayscale(1);}
    .achievement-unlocked { opacity: 1;}
    #icon-picker { max-height: 128px; }
    @media (max-width: 500px) {
      .spa-section { padding-left: 0 !important; padding-right: 0 !important; }
    }
    .hoh-logo { width: 100px; max-width: 33vw; margin-bottom: 0.3rem;}
    @media (min-width: 768px) {
      .hoh-logo { width: 120px; }
    }
    .shop-item { 
      border:2px solid #fbbf24; 
      border-radius:.5rem; 
      background: #fffbe6; 
      padding:.7rem .8rem; 
      margin-bottom:1rem;
      transition: all 0.2s ease;
    }
    .shop-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(251,191,36,0.2);
    }
    .shop-item.locked { opacity:.45; filter: grayscale(1);}
    .stat-label { font-weight:bold; color:#6366f1;}
    #onboarding-modal {background:rgba(32,16,64,0.85);}
    #onboarding-modal .modal-box {background:#fff; border-radius:1rem; max-width:375px; padding:2rem;}
    @media (max-width:500px) {
      #onboarding-modal .modal-box {max-width:95vw;}
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-purple-100 to-indigo-200 dark:from-gray-900 dark:via-gray-800 dark:to-indigo-900 text-gray-900 dark:text-gray-100 transition-colors min-h-screen rpg-font">
  
  <!-- Dark Mode Toggle -->
  <div id="dark-toggle-corner">
    <button id="dark-toggle-btn" title="Toggle dark mode">
      <i class="fas fa-moon text-gray-600 dark:hidden"></i>
      <i class="fas fa-sun hidden dark:block text-yellow-300"></i>
    </button>
  </div>

  <!-- Logo -->
  <div class="flex justify-center mt-2 mb-1">
    <img src="logo.png" alt="Hero of Habits Logo" class="hoh-logo drop-shadow-lg" />
  </div>
  
  <!-- Main Container -->
  <div class="container mx-auto px-4 py-8 max-w-3xl">
    <!-- Navigation -->
    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
      <div class="flex gap-2 flex-wrap w-full justify-center">
        <button class="rpg-btn px-3 py-1 rounded bg-indigo-100 dark:bg-indigo-800 text-indigo-900 dark:text-indigo-200 font-bold text-xs spa-nav active" data-tab="dashboard">
          <i class="fas fa-gauge"></i> Dashboard
        </button>
        <button class="rpg-btn px-3 py-1 rounded bg-green-100 dark:bg-green-800 text-green-900 dark:text-green-200 font-bold text-xs spa-nav" data-tab="inventory">
          <i class="fas fa-archive"></i> Inventory
        </button>
        <button class="rpg-btn px-3 py-1 rounded bg-yellow-100 dark:bg-yellow-800 text-yellow-900 dark:text-yellow-100 font-bold text-xs spa-nav" data-tab="shop">
          <i class="fas fa-store"></i> Shop
        </button>
        <button class="rpg-btn px-3 py-1 rounded bg-cyan-100 dark:bg-cyan-800 text-cyan-900 dark:text-cyan-200 font-bold text-xs spa-nav" data-tab="stats">
          <i class="fas fa-trophy"></i> Stats
        </button>
        <button class="rpg-btn px-3 py-1 rounded bg-yellow-50 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-100 font-bold text-xs spa-nav" data-tab="achievements">
          <i class="fas fa-medal"></i> Achievements
        </button>
        <button class="rpg-btn px-3 py-1 rounded bg-pink-100 dark:bg-pink-800 text-pink-900 dark:text-pink-200 font-bold text-xs spa-nav" data-tab="questlog">
          <i class="fas fa-scroll"></i> Quest Log
        </button>
        <button class="rpg-btn px-3 py-1 rounded bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 font-bold text-xs spa-nav" data-tab="settings">
          <i class="fas fa-cog"></i> Settings
        </button>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="spa-section active">
      <div class="flex items-center gap-4 mb-5 flex-wrap">
        <div class="rpg-avatar relative">
          <span id="avatar-bg" class="avatar-bg"></span>
          <!-- SVG Pixel Avatar -->
          <svg id="pixel-avatar" width="80" height="80" viewBox="0 0 80 80" class="pixel-avatar">
            <rect id="avatar-skin" x="16" y="16" width="48" height="48" rx="10" fill="#ffd8b2"/>
            <rect id="avatar-hair" x="16" y="8" width="48" height="24" rx="8" fill="#8d5524"/>
            <rect id="avatar-eye-l" x="28" y="38" width="6" height="6" rx="1.5" fill="#222"/>
            <rect id="avatar-eye-r" x="46" y="38" width="6" height="6" rx="1.5" fill="#222"/>
            <rect x="34" y="52" width="12" height="4" rx="2" fill="#de9246"/>
          </svg>
          <span id="avatar-hat" class="avatar-equip hat"></span>
          <span id="avatar-weapon" class="avatar-equip weapon"></span>
          <span id="avatar-shield" class="avatar-equip shield"></span>
          <span id="avatar-pet" class="avatar-equip pet"></span>
        </div>

        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-indigo-700 dark:text-indigo-300 rpg-font">Hero of Habits</h1>
          <div class="flex items-center gap-2 mt-2 flex-wrap">
            <span class="text-sm font-bold text-green-700 dark:text-green-300">Level <span id="hero-level">1</span></span>
            <span class="text-xs">XP:</span>
            <div class="relative w-32 h-3 bg-indigo-200 dark:bg-indigo-800 rounded">
              <div id="xp-bar" class="absolute left-0 top-0 h-3 rounded rpg-xp-bar" style="width: 0%"></div>
            </div>
            <span id="hero-xp" class="text-xs ml-2">0/50</span>
            <span id="coins" class="ml-3 text-xs font-bold text-yellow-700 dark:text-yellow-300"><i class="fas fa-coins"></i> 0</span>
            <span id="levelup-badge" class="ml-2 hidden rpg-quest"><i class="fas fa-star"></i> LEVEL UP!</span>
          </div>

          <!-- Avatar Customizer -->
          <div id="avatar-customizer" class="avatar-customizer">
            <label class="text-xs font-bold">Skin:</label>
            <span class="avatar-option avatar-skin" data-color="#ffd8b2" style="background:#ffd8b2"></span>
            <span class="avatar-option avatar-skin" data-color="#f1c27d" style="background:#f1c27d"></span>
            <span class="avatar-option avatar-skin" data-color="#c68642" style="background:#c68642"></span>
            <span class="avatar-option avatar-skin" data-color="#8d5524" style="background:#8d5524"></span>

            <label class="text-xs font-bold ml-4">Hair:</label>
            <span class="avatar-option avatar-hair" data-color="#8d5524" style="background:#8d5524"></span>
            <span class="avatar-option avatar-hair" data-color="#deb887" style="background:#deb887"></span>
            <span class="avatar-option avatar-hair" data-color="#222222" style="background:#222"></span>
            <span class="avatar-option avatar-hair" data-color="#e0e0e0" style="background:#e0e0e0"></span>

            <label class="text-xs font-bold ml-4">Eyes:</label>
            <span class="avatar-option avatar-eyes" data-color="#222222" style="background:#222"></span>
            <span class="avatar-option avatar-eyes" data-color="#1976d2" style="background:#1976d2"></span>
            <span class="avatar-option avatar-eyes" data-color="#43a047" style="background:#43a047"></span>

            <button id="confirm-avatar" class="confirm-avatar-btn w-full mt-4">
              <i class="fas fa-check"></i> Confirm Appearance
            </button>
          </div>

          <!-- Customize Avatar Button -->
          <button id="customize-avatar" class="customize-avatar-btn hidden">
            <i class="fas fa-paint-brush"></i> Customize Avatar
          </button>
        </div>
      </div>

      <div class="flex justify-end mb-4">
        <button id="add-habit-btn" class="bg-gradient-to-r from-green-400 via-indigo-500 to-purple-500 text-white px-4 py-2 rounded-full flex items-center gap-2 rpg-btn hover:scale-105 shadow">
          <i class="fas fa-plus"></i> New Quest
        </button>
      </div>
      <div id="habits-list" class="space-y-8"></div>
    </div>

    <!-- Other Sections -->
    <div id="inventory" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-archive"></i> Inventory</h2>
      <div class="flex flex-wrap gap-6" id="inventory-items"></div>
    </div>

    <div id="shop" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-store"></i> Shop</h2>
      <div class="mb-4 text-sm text-gray-600 dark:text-gray-300">Earn coins by completing quests and streaks. Buy new items or cosmetics here!</div>
      <div id="shop-items"></div>
    </div>

    <div id="stats" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-trophy"></i> Stats & Trophies</h2>
      <div id="stats-content" class="space-y-2"></div>
    </div>

    <div id="achievements" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-medal"></i> Achievements</h2>
      <div class="overflow-y-auto flex-1" id="achievements-list"></div>
    </div>

    <div id="questlog" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-scroll"></i> Quest Log</h2>
      <div id="questlog-content" class="max-h-96 overflow-y-auto"></div>
    </div>

    <div id="settings" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-cog"></i> Settings</h2>
      <div class="mb-4 space-y-2">
        <div>
          <label class="font-bold">Profile Name:</label>
          <input type="text" id="settings-name" class="ml-2 px-2 py-1 rounded border" style="width:120px;">
        </div>
        <div>
          <label class="font-bold">Sound:</label>
          <input type="checkbox" id="sound-toggle" class="ml-2">
        </div>
        <div>
          <label class="font-bold">Theme:</label>
          <select id="theme-select" class="ml-2 px-2 py-1 rounded border">
            <option value="system">System</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>
      <div class="mt-4 flex gap-3">
        <button onclick="exportData()" class="rpg-btn px-3 py-1 rounded bg-indigo-200 text-indigo-900 font-bold text-xs">
          <i class="fas fa-download"></i> Export Data
        </button>
        <label class="rpg-btn px-3 py-1 rounded bg-indigo-100 text-indigo-900 font-bold text-xs cursor-pointer">
          <i class="fas fa-upload"></i> Import Data
          <input type="file" id="import-data" accept="application/json" class="hidden">
        </label>
      </div>
    </div>

    <!-- Modals -->
    <div id="habit-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md rpg-card">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold" id="modal-title">New Quest</h3>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <form id="habit-form" class="space-y-4">
          <div>
            <label class="block mb-1 text-sm font-medium" for="habit-name">Quest Name</label>
            <input id="habit-name" type="text" required maxlength="40" 
                   class="w-full px-3 py-2 border rounded focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium" for="habit-goal">Target (per day)</label>
            <input id="habit-goal" type="number" min="1" max="100" required
                   class="w-full px-3 py-2 border rounded focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium" for="habit-type">Quest Type</label>
            <select id="habit-type" 
                    class="w-full px-3 py-2 border rounded focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
              <option value="mind">🧠 Mind</option>
              <option value="body">💪 Body</option>
              <option value="other">✨ Other</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium" for="habit-kind">Kind</label>
            <select id="habit-kind"
                    class="w-full px-3 py-2 border rounded focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
              <option value="recurring">Recurring</option>
              <option value="one-time">One-time</option>
              <option value="challenge">Challenge</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Icon</label>
            <input type="hidden" id="habit-icon" name="habit-icon">
            <div id="icon-picker" class="grid grid-cols-6 gap-2 max-h-40 overflow-y-auto border rounded p-2 bg-gray-100 dark:bg-gray-700"></div>
            <div class="text-xs mt-1 text-gray-500 dark:text-gray-300">Click to select an icon</div>
          </div>
          <button type="submit" class="bg-gradient-to-r from-green-400 to-indigo-500 text-white px-4 py-2 rounded rpg-btn hover:scale-105 w-full">
            Save Quest
          </button>
        </form>
      </div>
    </div>

    <div id="onboarding-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
      <div class="modal-box text-center">
        <h2 class="text-xl font-bold mb-2 text-indigo-700">Welcome to Hero of Habits!</h2>
        <div class="text-sm mb-4 text-gray-700">
          <p class="mb-2">Track your habits, earn XP, collect loot, and level up your pixel hero.<br>
          Complete daily quests, unlock achievements, and customize your avatar!</p>
          <ul class="list-disc list-inside text-left text-xs">
            <li>Complete quests to earn XP and coins</li>
            <li>Shop for new items and cosmetics</li>
            <li>Level up your hero and pets</li>
            <li>Earn daily log-in rewards</li>
            <li>Export/import your progress</li>
          </ul>
        </div>
        <button id="close-onboarding" class="bg-indigo-500 text-white px-4 py-2 rounded rpg-btn hover:scale-105 w-full mt-2">
          Let's Go!
        </button>
      </div>
    </div>

    <div id="confetti" class="confetti hidden"></div>
    
    <!-- Audio Elements -->
    <audio id="audio-levelup" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12a8b4e8c5.mp3" preload="auto"></audio>
    <audio id="audio-quest" src="https://cdn.pixabay.com/audio/2022/10/16/audio_128b07b7f2.mp3" preload="auto"></audio>
    <audio id="audio-achievement" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12b2e2a0b5.mp3" preload="auto"></audio>
    
    <!-- Footer -->
    <footer class="mt-16 text-center text-indigo-500 dark:text-indigo-200 border-t border-indigo-200 dark:border-indigo-700 pt-6">
      <p>Embark on your journey • <span class="animate-beat text-yellow-400"><i class="fas fa-star"></i></span> by <a href="https://github.com/untopo" class="text-indigo-600 hover:underline">Topo</a></p>
      <p class="mt-2 text-xs" id="local-time"></p>
    </footer>
  </div>

  <script>
    // --- Dark Mode & Theme Management ---
    function setDarkMode(enabled) {
      if (enabled) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
      }
    }

    // Fixed dark mode toggle with proper event handling
    document.getElementById('dark-toggle-btn').addEventListener('click', function() {
      const isDark = !document.documentElement.classList.contains('dark');
      setDarkMode(isDark);
    });

    // Initialize theme
(function() {
  let theme = localStorage.getItem('theme');
  if (!theme || theme === 'system') {
    theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  setDarkMode(theme === 'dark');
  document.getElementById('theme-select').value = localStorage.getItem('theme') || 'system';
})();

// Add this right after the initialization
document.getElementById('theme-select').addEventListener('change', function(e) {
  const theme = e.target.value;
  if (theme === 'system') {
    setDarkMode(window.matchMedia('(prefers-color-scheme: dark)').matches);
  } else {
    setDarkMode(theme === 'dark');
  }
  localStorage.setItem('theme', theme);
});

    // --- Avatar Customization System ---
    const avatarCustomization = {
      skin: localStorage.getItem('avatar-skin') || '#ffd8b2',
      hair: localStorage.getItem('avatar-hair') || '#8d5524',
      eyes: localStorage.getItem('avatar-eyes') || '#222222',
      confirmed: localStorage.getItem('avatar-confirmed') === 'true'
    };

    const customizer = document.getElementById('avatar-customizer');
    const customizeBtn = document.getElementById('customize-avatar');
    const confirmBtn = document.getElementById('confirm-avatar');

    function updateCustomizerVisibility() {
      if (avatarCustomization.confirmed) {
        customizer.classList.add('hidden');
        customizeBtn.classList.remove('hidden');
      } else {
        customizer.classList.remove('hidden');
        customizeBtn.classList.add('hidden');
      }
    }

    // Initialize avatar visibility
    updateCustomizerVisibility();

    customizeBtn.addEventListener('click', function() {
      avatarCustomization.confirmed = false;
      localStorage.setItem('avatar-confirmed', 'false');
      updateCustomizerVisibility();
    });

    confirmBtn.addEventListener('click', function() {
      avatarCustomization.confirmed = true;
      localStorage.setItem('avatar-confirmed', 'true');
      updateCustomizerVisibility();
      showConfetti();
      playSound('audio-achievement');
    });

    function updateAvatarPart(part, color) {
      if (part === 'eyes') {
        document.getElementById('avatar-eye-l').setAttribute('fill', color);
        document.getElementById('avatar-eye-r').setAttribute('fill', color);
      } else {
        document.getElementById(`avatar-${part}`).setAttribute('fill', color);
      }
      localStorage.setItem(`avatar-${part}`, color);
      avatarCustomization[part] = color;
    }

    // Updated avatar option click handlers
    document.querySelectorAll('.avatar-option').forEach(option => {
      const part = option.classList.contains('avatar-skin') ? 'skin' :
                   option.classList.contains('avatar-hair') ? 'hair' : 'eyes';
      const color = option.getAttribute('data-color');
      
      if (avatarCustomization[part] === color) {
        option.classList.add('selected');
      }

      option.onclick = function() {
        document.querySelectorAll(`.avatar-${part}`).forEach(opt => 
          opt.classList.remove('selected'));
        this.classList.add('selected');
        updateAvatarPart(part, color);
      };
    });

    // Initialize avatar with saved customization
    Object.entries(avatarCustomization).forEach(([part, color]) => {
      if (part !== 'confirmed') {
        updateAvatarPart(part, color);
      }
    });

    // --- SPA Navigation ---
    document.querySelectorAll('.spa-nav').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.spa-nav').forEach(b => 
          b.classList.remove('active'));
        document.querySelectorAll('.spa-section').forEach(sec => 
          sec.classList.remove('active'));
        
        btn.classList.add('active');
        const section = document.getElementById(btn.dataset.tab);
        if (section) {
          section.classList.add('active');
          
          switch(btn.dataset.tab) {
            case "achievements": renderAchievementsPage(); break;
            case "inventory": renderInventoryPage(); break;
            case "shop": renderShopPage(); break;
            case "stats": renderStatsPage(); break;
            case "questlog": renderQuestLogPage(); break;
            case "dashboard": renderHabits(); break;
            case "settings": renderSettingsPage(); break;
          }
        }
      });
    });

    // --- RPG Data Management ---
    let hero = JSON.parse(localStorage.getItem('rpg-hero')) || {
      xp: 0,
      level: 1,
      items: [],
      achievements: [],
      coins: 0,
      name: "Hero"
    };
    
    let habits = JSON.parse(localStorage.getItem('rpg-habits') || "[]");
    let questLog = JSON.parse(localStorage.getItem('rpg-questlog') || "[]");
    let equipped = JSON.parse(localStorage.getItem('rpg-equipped') || "{}");
    
    const xpPerHabit = 10;
    const baseXp = 50;
    
    function xpToNext(level) {
      return baseXp + (level-1)*25;
    }
    
    function todayISO() {
      return new Date().toISOString().slice(0,10);
    }
    
    let editingHabit = null;

    // --- Shop Items ---
    const shopItems = [
      { name: "Cowboy Hat", icon: "fa-hat-cowboy", price: 20, type: "hat" },
      { name: "Space Helmet", icon: "fa-user-astronaut", price: 30, type: "hat" },
      { name: "Golden Sword", icon: "fa-star", price: 35, type: "weapon" },
      { name: "Magic Shield", icon: "fa-shield-virus", price: 25, type: "shield" },
      { name: "Bunny Pet", icon: "fa-hippo", price: 30, type: "pet" },
      { name: "Sky BG", icon: "fa-cloud", price: 40, type: "background" }
    ];

    // ---- Icon Picker ----
    const questIcons = [
      "fa-dumbbell", "fa-book", "fa-mug-hot", "fa-bolt", "fa-seedling", "fa-water",
      "fa-brain", "fa-running", "fa-mountain", "fa-paw", "fa-heart", "fa-music",
      "fa-leaf", "fa-medal", "fa-star", "fa-fire", "fa-code", "fa-apple-alt",
      "fa-bed", "fa-bicycle", "fa-broom", "fa-chess", "fa-gamepad", "fa-fish",
      "fa-peace", "fa-shield-alt", "fa-dog", "fa-cat", "fa-campground", "fa-tree",
      "fa-rocket"
    ];

    function renderIconPicker(selectedIcon) {
      const picker = document.getElementById('icon-picker');
      picker.innerHTML = questIcons.map(icon => `
        <button type="button" class="p-2 rounded hover:bg-indigo-200 dark:hover:bg-indigo-800 transition
          ${selectedIcon === icon ? 'bg-indigo-300 dark:bg-indigo-700 ring-2 ring-indigo-500' : ''}"
          onclick="document.getElementById('habit-icon').value='${icon}';renderIconPicker('${icon}')">
          <i class="fas ${icon} text-2xl"></i>
        </button>
      `).join('');
    }

    // ---- Equipment & Items ----
    const allItems = [
      { name: "Wizard Hat", icon: "fa-hat-wizard", type: "hat", unlock: ()=>hero.level>=2 },
      { name: "Sword", icon: "fa-sword", type: "weapon", unlock: ()=>hero.level>=4 },
      { name: "Crown", icon: "fa-crown", type: "hat", unlock: ()=>hero.level>=10 },
      { name: "Shield", icon: "fa-shield-alt", type: "shield", unlock: ()=>hero.level>=7 },
      { name: "Dog Pet", icon: "fa-dog", type: "pet", unlock: ()=>habits.some(h=>h.streak>=14) },
      { name: "Cat Pet", icon: "fa-cat", type: "pet", unlock: ()=>hero.achievements.includes("night-owl") },
      { name: "Forest BG", icon: "fa-tree", type: "background", unlock: ()=>hero.level>=8 },
      ...shopItems
    ];

    // ---- Achievements ----
    const allAchievements = [
      {
        key: "first-quest",
        name: "First Quest",
        icon: "fa-medal",
        desc: "Add your first quest.",
        unlocked: () => habits.length > 0,
        bonus: "+10 XP",
        onUnlock: () => gainXP(10)
      },
      {
        key: "level-5",
        name: "Level 5",
        icon: "fa-trophy",
        desc: "Reach level 5.",
        unlocked: () => hero.level >= 5,
        bonus: "+25 XP",
        onUnlock: () => gainXP(25)
      },
      {
        key: "streak-3",
        name: "3-Day Streak",
        icon: "fa-fire",
        desc: "Reach a 3-day streak in any quest.",
        unlocked: () => habits.some(h=>h.streak>=3),
        bonus: "+10 XP",
        onUnlock: () => gainXP(10)
      },
      {
        key: "streak-7",
        name: "7-Day Streak",
        icon: "fa-fire",
        desc: "Reach a 7-day streak in any quest.",
        unlocked: () => habits.some(h=>h.streak>=7),
        bonus: "+30 XP",
        onUnlock: () => gainXP(30)
      },
      {
        key: "ten-quests",
        name: "Quest Collector",
        icon: "fa-star",
        desc: "Add 10 quests.",
        unlocked: () => habits.length >= 10,
        bonus: "+20 XP",
        onUnlock: () => gainXP(20)
      },
      {
        key: "perfect-day",
        name: "Perfect Day",
        icon: "fa-gem",
        desc: "Complete all quests for today.",
        unlocked: () => habits.length > 0 && habits.every(h=>h.progress===h.goal),
        bonus: "Gem Badge",
        onUnlock: () => {}
      },
      {
        key: "night-owl",
        name: "Night Owl",
        icon: "fa-moon",
        desc: "Log a quest between 11pm and 4am.",
        unlocked: () => {
          const h = new Date().getHours();
          return h >= 23 || h < 4;
        },
        bonus: "Cat Pet",
        onUnlock: () => {}
      }
    ];

    function renderInventoryPage() {
  const el = document.getElementById('inventory-items');
  el.innerHTML = allItems.map(item => {
    const unlocked = hero.items.includes(item.name);
    return `
      <div class="flex flex-col items-center text-center cursor-pointer ${unlocked?'':'opacity-30'}"
        onclick="equipItem('${item.name}')"
        title="${item.name}">
        <span class="text-4xl"><i class="fas ${item.icon}"></i></span>
        <span class="text-xs mt-1">${item.name}</span>
      </div>`;
  }).join("");
}

function renderShopPage() {
  document.getElementById('shop-items').innerHTML = shopItems.map(item => {
    const owned = hero.items.includes(item.name);
    return `
      <div class="shop-item ${owned?'locked':''}">
        <span class="text-xl"><i class="fas ${item.icon}"></i></span>
        <span class="ml-2 font-bold">${item.name}</span>
        <span class="ml-2 text-xs text-gray-500">(${item.type})</span>
        <span class="ml-3 text-yellow-700"><i class="fas fa-coins"></i> ${item.price}</span>
        ${owned ? 
          `<span class="ml-3 text-green-700 font-bold">Owned</span>` : 
          `<button onclick="buyShopItem('${item.name}')" class="ml-4 px-2 py-1 text-xs rounded bg-yellow-200 font-bold hover:bg-yellow-300">Buy</button>`}
      </div>`;
  }).join('');
}

function renderStatsPage() {
  const stats = getStats();
  document.getElementById('stats-content').innerHTML = `
    <div class="stat-label">Total Quests Completed:</div> <b>${stats.completed}</b>
    <div class="stat-label">Current Quests:</div> <b>${stats.totalQuests}</b>
    <div class="stat-label">Highest Streak:</div> <b>${stats.highestStreak}</b>
    <div class="stat-label">Total XP Earned:</div> <b>${stats.totalXP}</b>
    <div class="stat-label">Coins Collected:</div> <b>${hero.coins||0}</b>
  `;
}

function renderQuestLogPage() {
  const ql = document.getElementById("questlog-content");
  if (!questLog.length) {
    ql.innerHTML = `<div class="text-center text-gray-500">No quest history yet. Complete quests to fill your log!</div>`;
    return;
  }
  ql.innerHTML = questLog.reverse().map(entry => {
    return `<div class="mb-2">${entry.date}: ${entry.action}</div>`;
  }).join('');
}

function renderAchievementsPage() {
  const el = document.getElementById('achievements-list');
  el.innerHTML = allAchievements.map(ach => {
    const unlocked = hero.achievements.includes(ach.key);
    return `<div class="flex items-start gap-4 mb-4 ${unlocked?'achievement-unlocked':'achievement-locked'}">
      <div class="text-3xl mt-1"><i class="fas ${ach.icon}"></i></div>
      <div>
        <div class="font-bold">${ach.name}</div>
        <div class="text-sm mb-1">${ach.desc}</div>
        <div class="text-xs ${unlocked?'text-green-600':'text-gray-400'}">${unlocked?'Unlocked':'Locked'}</div>
      </div>
    </div>`;
  }).join("");
}

function showConfetti() {
  const confetti = document.getElementById('confetti');
  confetti.innerHTML = "";
  confetti.classList.remove('hidden');
  const colors = ['#4ade80', '#6366f1', '#7c3aed', '#fbbf24', '#f472b6'];
  for (let i=0; i<32; i++) {
    let el = document.createElement('div');
    el.className = "confetti-piece";
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.left = (5 + Math.random()*90) + "vw";
    el.style.top = (Math.random()*10) + "vh";
    el.style.transform = `rotate(${Math.random()*360}deg)`;
    confetti.appendChild(el);
  }
  setTimeout(()=>{ confetti.classList.add('hidden'); }, 1300);
}

// Initialize everything
function initializeApp() {
  renderIconPicker(questIcons[0]);
  updateHeroDisplay();
  renderHabits();
  renderAvatar();
  renderInventoryPage();
  renderAchievementsPage();
  renderQuestLogPage();
  renderShopPage();
  renderStatsPage();
  renderSettingsPage();
  grantAchievements();
  updateCustomizerVisibility();
}

    // Call initialize function when document is ready
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
