<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hero of Habits - RPG Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body, .rpg-font { font-family: 'Press Start 2P', monospace, sans-serif; }
    .rpg-card { border: 3px solid #a78bfa; border-radius: 1rem; box-shadow: 0 2px 12px #8b5cf633; }
    .rpg-glow { box-shadow: 0 0 20px 4px #3b82f6cc, 0 0 0 2px #a78bfa; }
    .level-up { animation: levelup-pop 0.8s; }
    @keyframes levelup-pop {
      0% { transform: scale(1);}
      20% { transform: scale(1.2) rotate(-2deg);}
      60% { transform: scale(1.1);}
      100% { transform: scale(1);}
    }
    .rpg-xp-bar {
      background: linear-gradient(90deg, #4ade80, #6366f1 60%, #7c3aed);
      box-shadow: 0 0 6px #6366f1cc;
      transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
    }
    .rpg-avatar {
      width: 96px; height: 96px; background: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 12px #7c3aed77; position: relative;
      overflow: visible;
    }
    .pixel-avatar {
      width: 80px; height: 80px;
      image-rendering: pixelated;
      border-radius: 10px;
      border: 2px solid #6366f1;
      background: #fff;
      margin: auto;
      z-index: 1;
      position: relative;
    }
    .avatar-equip { position: absolute; z-index: 2; pointer-events:none;}
    .avatar-equip.hat { left: 50%; top: -16px; transform: translateX(-50%); }
    .avatar-equip.weapon { right: 0; bottom: 8px;}
    .avatar-equip.shield { left: 0; bottom: 8px;}
    .avatar-equip.pet { left: 50%; bottom: -18px; transform: translateX(-50%);}
    .avatar-bg { position:absolute; left:0; top:0; width:100%; height:100%; border-radius:50%; z-index:0; }
    .rpg-quest {
      background: linear-gradient(90deg, #fbbf24 40%, #f472b6 100%);
      color: #78350f;
      font-weight: bold;
      border-radius: 0.5rem;
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
      margin-left: 0.5rem;
    }
    .rpg-btn {
      border: 2px solid #a78bfa;
      box-shadow: 0 1px 4px #a78bfa22;
    }
    .confetti {
      pointer-events: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh; z-index: 1001;
      display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start;
      overflow: hidden;
    }
    .confetti-piece {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      opacity: 0.8;
      position: absolute;
      will-change: transform, opacity;
      animation: confetti-fall 1.2s linear forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1;}
      80% { opacity: 1;}
      100% { transform: translateY(600px) rotate(360deg) scale(0.8); opacity: 0;}
    }
    /* SPA navigation */
    .spa-section { display: none; }
    .spa-section.active { display: block; }
    /* Inventory/Achievements sidebar/modal */
    .achievement-locked { opacity: 0.3; filter: grayscale(1);}
    .achievement-unlocked { opacity: 1;}
    /* Icon picker grid */
    #icon-picker { max-height: 128px; }
    @media (max-width: 500px) {
      .spa-section { padding-left: 0 !important; padding-right: 0 !important; }
    }
    /* Logo tweaks */
    .hoh-logo { width: 100px; max-width: 33vw; margin-bottom: 0.3rem;}
    @media (min-width: 768px) {
      .hoh-logo { width: 120px; }
    }
    /* Avatar upload preview */
    #avatar-upload-preview { border: 2px dashed #a78bfa; border-radius: 0.5rem; padding: .3rem; display: inline-block; background: #fff3; }
    /* Shop styling */
    .shop-item { border:2px solid #fbbf24; border-radius:.5rem; background: #fffbe6; padding:.7rem .8rem; margin-bottom:1rem;}
    .shop-item.locked { opacity:.45; filter: grayscale(1);}
    /* Stats/Trophies styling */
    .stat-label { font-weight:bold; color:#6366f1;}
    /* Onboarding modal */
    #onboarding-modal {background:rgba(32,16,64,0.85);}
    #onboarding-modal .modal-box {background:#fff; border-radius:1rem; max-width:375px; padding:2rem;}
    @media (max-width:500px) {
      #onboarding-modal .modal-box {max-width:95vw;}
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-purple-100 to-indigo-200 dark:from-gray-900 dark:via-gray-800 dark:to-indigo-900 text-gray-900 dark:text-gray-100 transition-colors min-h-screen rpg-font">
  <!-- Hero of Habits Logo at top center -->
  <div class="flex justify-center mt-2 mb-1">
    <img src="logo.png" alt="Hero of Habits Logo" class="hoh-logo drop-shadow-lg" />
  </div>
  <div class="container mx-auto px-4 py-8 max-w-3xl">
    <!-- Top Nav / Tabs -->
    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
      <div class="flex gap-2 flex-wrap">
        <button class="rpg-btn px-3 py-1 rounded bg-indigo-100 dark:bg-indigo-800 text-indigo-900 dark:text-indigo-200 font-bold text-xs spa-nav" data-tab="dashboard"><i class="fas fa-gauge"></i> Dashboard</button>
        <button class="rpg-btn px-3 py-1 rounded bg-green-100 dark:bg-green-800 text-green-900 dark:text-green-200 font-bold text-xs spa-nav" data-tab="inventory"><i class="fas fa-archive"></i> Inventory</button>
        <button class="rpg-btn px-3 py-1 rounded bg-yellow-100 dark:bg-yellow-800 text-yellow-900 dark:text-yellow-100 font-bold text-xs spa-nav" data-tab="shop"><i class="fas fa-store"></i> Shop</button>
        <button class="rpg-btn px-3 py-1 rounded bg-cyan-100 dark:bg-cyan-800 text-cyan-900 dark:text-cyan-200 font-bold text-xs spa-nav" data-tab="stats"><i class="fas fa-trophy"></i> Stats</button>
        <button class="rpg-btn px-3 py-1 rounded bg-yellow-50 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-100 font-bold text-xs spa-nav" data-tab="achievements"><i class="fas fa-medal"></i> Achievements</button>
        <button class="rpg-btn px-3 py-1 rounded bg-pink-100 dark:bg-pink-800 text-pink-900 dark:text-pink-200 font-bold text-xs spa-nav" data-tab="questlog"><i class="fas fa-scroll"></i> Quest Log</button>
        <button class="rpg-btn px-3 py-1 rounded bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 font-bold text-xs spa-nav" data-tab="settings"><i class="fas fa-cog"></i> Settings</button>
      </div>
      <button id="dark-toggle" class="w-10 h-10 flex items-center justify-center rounded-full bg-indigo-100 dark:bg-indigo-800 hover:bg-indigo-200 dark:hover:bg-indigo-700 transition">
        <i class="fas fa-moon text-gray-600 block dark:hidden"></i>
        <i class="fas fa-sun hidden dark:block text-yellow-300"></i>
      </button>
    </div>

    <!-- SPA Sections Start -->
    <!-- Dashboard Page -->
    <div id="dashboard" class="spa-section active">
      <div class="flex items-center gap-4 mb-5 flex-wrap">
        <div class="rpg-avatar relative">
          <span id="avatar-bg" class="avatar-bg"></span>
          <img id="pixel-avatar" class="pixel-avatar" src="https://raw.githubusercontent.com/untopo/otpo-assets/main/pixel-hero.png" alt="Avatar">
          <span id="avatar-hat" class="avatar-equip hat"></span>
          <span id="avatar-weapon" class="avatar-equip weapon"></span>
          <span id="avatar-shield" class="avatar-equip shield"></span>
          <span id="avatar-pet" class="avatar-equip pet"></span>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-indigo-700 dark:text-indigo-300 rpg-font">Hero of Habits</h1>
          <div class="flex items-center gap-2 mt-2 flex-wrap">
            <span class="text-sm font-bold text-green-700 dark:text-green-300">Level <span id="hero-level">1</span></span>
            <span class="text-xs">XP:</span>
            <div class="relative w-32 h-3 bg-indigo-200 dark:bg-indigo-800 rounded">
              <div id="xp-bar" class="absolute left-0 top-0 h-3 rounded rpg-xp-bar" style="width: 0%"></div>
            </div>
            <span id="hero-xp" class="text-xs ml-2">0/50</span>
            <span id="coins" class="ml-3 text-xs font-bold text-yellow-700 dark:text-yellow-300"><i class="fas fa-coins"></i> 0</span>
            <span id="levelup-badge" class="ml-2 hidden rpg-quest"><i class="fas fa-star"></i> LEVEL UP!</span>
          </div>
        </div>
      </div>
      <!-- Add Habit Button -->
      <div class="flex justify-end mb-4">
        <button id="add-habit-btn" class="bg-gradient-to-r from-green-400 via-indigo-500 to-purple-500 text-white px-4 py-2 rounded-full flex items-center gap-2 rpg-btn hover:scale-105 shadow">
          <i class="fas fa-plus"></i> New Quest
        </button>
      </div>
      <!-- Habits List (Quests) -->
      <div id="habits-list" class="space-y-8"></div>
    </div>
    <!-- Inventory Page -->
    <div id="inventory" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-archive"></i> Inventory</h2>
      <div class="flex flex-wrap gap-6" id="inventory-items"></div>
    </div>
    <!-- Shop Page -->
    <div id="shop" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-store"></i> Shop</h2>
      <div class="mb-4 text-sm text-gray-600 dark:text-gray-300">Earn coins by completing quests and streaks. Buy new items or cosmetics here!</div>
      <div id="shop-items"></div>
    </div>
    <!-- Stats/Trophies Page -->
    <div id="stats" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-trophy"></i> Stats & Trophies</h2>
      <div id="stats-content" class="space-y-2"></div>
    </div>
    <!-- Achievements Page -->
    <div id="achievements" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-medal"></i> Achievements</h2>
      <div class="overflow-y-auto flex-1" id="achievements-list"></div>
    </div>
    <!-- Quest Log Page -->
    <div id="questlog" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-scroll"></i> Quest Log</h2>
      <div id="questlog-content" class="max-h-96 overflow-y-auto"></div>
    </div>
    <!-- Settings Page -->
    <div id="settings" class="spa-section">
      <h2 class="text-xl font-bold mb-2"><i class="fas fa-cog"></i> Settings</h2>
      <div class="mb-4 space-y-2">
        <div>
          <label class="font-bold">Profile Name:</label>
          <input type="text" id="settings-name" class="ml-2 px-2 py-1 rounded border" style="width:120px;">
        </div>
        <div>
          <label class="font-bold">Sound:</label>
          <input type="checkbox" id="sound-toggle" class="ml-2">
        </div>
        <div>
          <label class="font-bold">Theme:</label>
          <select id="theme-select" class="ml-2 px-2 py-1 rounded border">
            <option value="system">System</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div>
          <label class="font-bold">Custom Avatar:</label>
          <input type="file" id="avatar-upload" accept="image/*" class="ml-2">
          <span id="avatar-upload-preview"></span>
        </div>
      </div>
      <div class="mt-4 flex gap-3">
        <button onclick="exportData()" class="rpg-btn px-3 py-1 rounded bg-indigo-200 text-indigo-900 font-bold text-xs"><i class="fas fa-download"></i> Export Data</button>
        <label class="rpg-btn px-3 py-1 rounded bg-indigo-100 text-indigo-900 font-bold text-xs cursor-pointer">
          <i class="fas fa-upload"></i> Import Data
          <input type="file" id="import-data" accept="application/json" class="hidden">
        </label>
      </div>
    </div>
    <!-- Add/Edit Habit Modal -->
    <div id="habit-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md rpg-card">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold" id="modal-title">New Quest</h3>
          <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"><i class="fas fa-times"></i></button>
        </div>
        <form id="habit-form" class="space-y-4">
          <div>
            <label class="block mb-1 text-sm font-medium" for="habit-name">Quest Name</label>
            <input id="habit-name" type="text" required maxlength="40" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium" for="habit-goal">Target (per day)</label>
            <input id="habit-goal" type="number" min="1" max="100" required class="w-full px-3 py-2 border rounded focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium" for="habit-type">Quest Type</label>
            <select id="habit-type" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
              <option value="mind">🧠 Mind</option>
              <option value="body">💪 Body</option>
              <option value="other">✨ Other</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium" for="habit-kind">Kind</label>
            <select id="habit-kind" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
              <option value="recurring">Recurring</option>
              <option value="one-time">One-time</option>
              <option value="challenge">Challenge</option>
            </select>
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Icon</label>
            <input type="hidden" id="habit-icon" name="habit-icon">
            <div id="icon-picker" class="grid grid-cols-6 gap-2 max-h-40 overflow-y-auto border rounded p-2 bg-gray-100 dark:bg-gray-700"></div>
            <div class="text-xs mt-1 text-gray-500 dark:text-gray-300">Click to select an icon</div>
          </div>
          <button type="submit" class="bg-gradient-to-r from-green-400 to-indigo-500 text-white px-4 py-2 rounded rpg-btn hover:scale-105 w-full">Save Quest</button>
        </form>
      </div>
    </div>
    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
      <div class="modal-box text-center">
        <h2 class="text-xl font-bold mb-2 text-indigo-700">Welcome to Hero of Habits!</h2>
        <div class="text-sm mb-4 text-gray-700">
          <p class="mb-2">Track your habits, earn XP, collect loot, and level up your pixel hero.<br>
          Complete daily quests, unlock achievements, and customize your avatar!</p>
          <ul class="list-disc list-inside text-left text-xs">
            <li>Complete quests to earn XP and coins</li>
            <li>Shop for new items and cosmetics</li>
            <li>Level up your hero and pets</li>
            <li>Earn daily log-in rewards</li>
            <li>Export/import your progress</li>
          </ul>
        </div>
        <button id="close-onboarding" class="bg-indigo-500 text-white px-4 py-2 rounded rpg-btn hover:scale-105 w-full mt-2">Let's Go!</button>
      </div>
    </div>
    <div id="confetti" class="confetti hidden"></div>
    <audio id="audio-levelup" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12a8b4e8c5.mp3" preload="auto"></audio>
    <audio id="audio-quest" src="https://cdn.pixabay.com/audio/2022/10/16/audio_128b07b7f2.mp3" preload="auto"></audio>
    <audio id="audio-achievement" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12b2e2a0b5.mp3" preload="auto"></audio>
    <footer class="mt-16 text-center text-indigo-500 dark:text-indigo-200 border-t border-indigo-200 dark:border-indigo-700 pt-6">
      <p>Embark on your journey • <span class="animate-beat text-yellow-400"><i class="fas fa-star"></i></span> by <a href="https://github.com/untopo" class="text-indigo-600 hover:underline">Topo</a></p>
      <p class="mt-2 text-xs" id="local-time"></p>
    </footer>
  </div>
  <script>
// --- SPA Navigation ---
document.querySelectorAll('.spa-nav').forEach(btn=>{
  btn.onclick = () => {
    document.querySelectorAll('.spa-section').forEach(sec=>sec.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    // Re-render current tab on navigation
    if (btn.dataset.tab === "achievements") renderAchievementsPage();
    if (btn.dataset.tab === "inventory") renderInventoryPage();
    if (btn.dataset.tab === "shop") renderShopPage();
    if (btn.dataset.tab === "stats") renderStatsPage();
    if (btn.dataset.tab === "questlog") renderQuestLogPage();
    if (btn.dataset.tab === "dashboard") { renderHabits(); renderAvatar(); }
    if (btn.dataset.tab === "settings") renderSettingsPage();
  };
});

// --- RPG Data ---
let hero = JSON.parse(localStorage.getItem('rpg-hero')) || { xp: 0, level: 1, items: [], achievements: [], coins: 0, name: "Hero" };
let habits = JSON.parse(localStorage.getItem('rpg-habits') || "[]");
let questLog = JSON.parse(localStorage.getItem('rpg-questlog') || "[]");
let equipped = JSON.parse(localStorage.getItem('rpg-equipped') || "{}");
const xpPerHabit = 10, baseXp = 50;
function xpToNext(level) { return baseXp + (level-1)*25; }
function todayISO() { return new Date().toISOString().slice(0,10);}
let editingHabit = null;

// --- Shop Items ---
const shopItems = [
  { name: "Cowboy Hat", icon: "fa-hat-cowboy", price: 20, type: "hat" },
  { name: "Space Helmet", icon: "fa-user-astronaut", price: 30, type: "hat" },
  { name: "Golden Sword", icon: "fa-star", price: 35, type: "weapon" },
  { name: "Magic Shield", icon: "fa-shield-virus", price: 25, type: "shield" },
  { name: "Bunny Pet", icon: "fa-hippo", price: 30, type: "pet" },
  { name: "Sky BG", icon: "fa-cloud", price: 40, type: "background" }
];

// ---- Icon Picker ----
const questIcons = [
  "fa-dumbbell", "fa-book", "fa-mug-hot", "fa-bolt", "fa-seedling", "fa-water",
  "fa-brain", "fa-running", "fa-mountain", "fa-paw", "fa-heart", "fa-music",
  "fa-leaf", "fa-medal", "fa-star", "fa-fire", "fa-code", "fa-apple-alt",
  "fa-bed", "fa-bicycle", "fa-broom", "fa-chess", "fa-gamepad", "fa-fish", "fa-peace",
  "fa-shield-alt", "fa-dog", "fa-cat", "fa-campground", "fa-tree", "fa-rocket"
];
function renderIconPicker(selectedIcon) {
  const picker = document.getElementById('icon-picker');
  picker.innerHTML = '';
  questIcons.forEach(icon => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = `p-2 rounded hover:bg-indigo-200 dark:hover:bg-indigo-800 transition
      ${selectedIcon === icon ? 'bg-indigo-300 dark:bg-indigo-700 ring-2 ring-indigo-500' : ''}`;
    btn.innerHTML = `<i class="fas ${icon} text-2xl"></i>`;
    btn.onclick = () => {
      document.getElementById('habit-icon').value = icon;
      renderIconPicker(icon);
    };
    picker.appendChild(btn);
  });
}

// ---- Equipment, Items, Achievements ----
const allItems = [
  { name: "Wizard Hat", icon: "fa-hat-wizard", type: "hat", unlock: ()=>hero.level>=2 },
  { name: "Sword", icon: "fa-sword", type: "weapon", unlock: ()=>hero.level>=4 },
  { name: "Crown", icon: "fa-crown", type: "hat", unlock: ()=>hero.level>=10 },
  { name: "Shield", icon: "fa-shield-alt", type: "shield", unlock: ()=>hero.level>=7 },
  { name: "Dog Pet", icon: "fa-dog", type: "pet", unlock: ()=>habits.some(h=>h.streak>=14) },
  { name: "Cat Pet", icon: "fa-cat", type: "pet", unlock: ()=>hero.achievements.includes("night-owl") },
  { name: "Forest BG", icon: "fa-tree", type: "background", unlock: ()=>hero.level>=8 },
  ...shopItems // Shop items get added as unlockable
];
const allAchievements = [
  {
    key: "first-quest",
    name: "First Quest",
    icon: "fa-medal",
    desc: "Add your first quest.",
    unlocked: () => habits.length > 0,
    bonus: "+10 XP",
    onUnlock: () => gainXP(10)
  },
  {
    key: "level-5",
    name: "Level 5",
    icon: "fa-trophy",
    desc: "Reach level 5.",
    unlocked: () => hero.level >= 5,
    bonus: "+25 XP",
    onUnlock: () => gainXP(25)
  },
  {
    key: "streak-3",
    name: "3-Day Streak",
    icon: "fa-fire",
    desc: "Reach a 3-day streak in any quest.",
    unlocked: () => habits.some(h=>h.streak>=3),
    bonus: "+10 XP",
    onUnlock: () => gainXP(10)
  },
  {
    key: "streak-7",
    name: "7-Day Streak",
    icon: "fa-fire",
    desc: "Reach a 7-day streak in any quest.",
    unlocked: () => habits.some(h=>h.streak>=7),
    bonus: "+30 XP",
    onUnlock: () => gainXP(30)
  },
  {
    key: "ten-quests",
    name: "Quest Collector",
    icon: "fa-star",
    desc: "Add 10 quests.",
    unlocked: () => habits.length >= 10,
    bonus: "+20 XP",
    onUnlock: () => gainXP(20)
  },
  {
    key: "perfect-day",
    name: "Perfect Day",
    icon: "fa-gem",
    desc: "Complete all quests for today.",
    unlocked: () => habits.length > 0 && habits.every(h=>h.progress===h.goal),
    bonus: "Gem Badge",
    onUnlock: () => {}
  },
  {
    key: "night-owl",
    name: "Night Owl",
    icon: "fa-moon",
    desc: "Log a quest between 11pm and 4am.",
    unlocked: () => { let h=new Date(); return h.getHours()>=23||h.getHours()<4; },
    bonus: "Cat Pet",
    onUnlock: () => {}
  }
];
function unlockItem(item) {
  if (!hero.items.includes(item)) {
    hero.items.push(item);
    localStorage.setItem('rpg-hero', JSON.stringify(hero));
  }
}
function grantAchievements() {
  hero.achievements = hero.achievements || [];
  let changed = false;
  allAchievements.forEach(ach => {
    if (!hero.achievements.includes(ach.key) && ach.unlocked()) {
      hero.achievements.push(ach.key);
      changed = true;
      ach.onUnlock && ach.onUnlock();
      playSound("audio-achievement");
      showConfetti();
    }
  });
  if (changed) localStorage.setItem('rpg-hero', JSON.stringify(hero));
}
function renderInventoryPage() {
  // Unlock items if necessary
  allItems.forEach(it=>{
    if (it.unlock && it.unlock() && !hero.items.includes(it.name)) unlockItem(it.name);
  });
  const el = document.getElementById('inventory-items');
  el.innerHTML = allItems.map(it=>{
    const unlocked = hero.items.includes(it.name);
    return `<div class="flex flex-col items-center text-center cursor-pointer ${unlocked?'':'opacity-30'}"
      onclick="equipItem('${it.name}')"
      title="${it.name}">
      <span class="text-4xl"><i class="fas ${it.icon}"></i></span>
      <span class="text-xs mt-1">${it.name}</span>
    </div>`;
  }).join("");
}
window.equipItem = equipItem;
function equipItem(itemName) {
  if (!hero.items.includes(itemName)) return;
  const item = allItems.find(i=>i.name===itemName);
  if (!item) return;
  equipped[item.type] = itemName;
  localStorage.setItem('rpg-equipped', JSON.stringify(equipped));
  renderAvatar();
}
function renderAvatar() {
  // background
  let bg = (equipped.background==="Forest BG")
    ? "url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?fit=crop&w=100&q=30')" : 
    (equipped.background==="Sky BG")
    ? "linear-gradient(180deg, #dbeafe, #fffde4 80%)" : "";
  document.getElementById("avatar-bg").style.backgroundImage = bg ? `url('${bg}')` : "";
  // hat
  let hat = "";
  if (equipped.hat==="Crown") hat = `<i class="fas fa-crown text-yellow-400 text-3xl"></i>`;
  else if (equipped.hat==="Wizard Hat") hat = `<i class="fas fa-hat-wizard text-purple-500 text-3xl"></i>`;
  else if (equipped.hat==="Cowboy Hat") hat = `<i class="fas fa-hat-cowboy text-yellow-900 text-3xl"></i>`;
  else if (equipped.hat==="Space Helmet") hat = `<i class="fas fa-user-astronaut text-blue-400 text-3xl"></i>`;
  document.getElementById('avatar-hat').innerHTML = hat;
  // weapon
  document.getElementById('avatar-weapon').innerHTML =
    (equipped.weapon==="Sword" ? `<i class="fas fa-sword text-gray-200 text-2xl"></i>` : "") +
    (equipped.weapon==="Golden Sword" ? `<i class="fas fa-star text-yellow-500 text-2xl"></i>` : "");
  // shield
  document.getElementById('avatar-shield').innerHTML =
    (equipped.shield==="Shield" ? `<i class="fas fa-shield-alt text-blue-400 text-2xl"></i>` : "") +
    (equipped.shield==="Magic Shield" ? `<i class="fas fa-shield-virus text-fuchsia-400 text-2xl"></i>` : "");
  // pet
  document.getElementById('avatar-pet').innerHTML =
    (equipped.pet==="Dog Pet" ? `<i class="fas fa-dog text-yellow-700 text-2xl"></i>` : "") +
    (equipped.pet==="Cat Pet" ? `<i class="fas fa-cat text-pink-400 text-2xl"></i>` : "") +
    (equipped.pet==="Bunny Pet" ? `<i class="fas fa-hippo text-gray-400 text-2xl"></i>` : "");
  // Avatar image (custom)
  const custom = localStorage.getItem('custom-avatar');
  document.getElementById("pixel-avatar").src = custom || "https://raw.githubusercontent.com/untopo/otpo-assets/main/pixel-hero.png";
}

// ---- Shop Page ----
function renderShopPage() {
  document.getElementById('shop-items').innerHTML = shopItems.map(item => {
    const owned = hero.items.includes(item.name);
    return `<div class="shop-item ${owned?'locked':''}">
      <span class="text-xl"><i class="fas ${item.icon}"></i></span>
      <span class="ml-2 font-bold">${item.name}</span>
      <span class="ml-2 text-xs text-gray-500">(${item.type})</span>
      <span class="ml-3 text-yellow-700"><i class="fas fa-coins"></i> ${item.price}</span>
      ${owned ? `<span class="ml-3 text-green-700 font-bold">Owned</span>` : `<button onclick="buyShopItem('${item.name}')" class="ml-4 px-2 py-1 text-xs rounded bg-yellow-200 font-bold hover:bg-yellow-300">Buy</button>`}
    </div>`;
  }).join('');
}
window.buyShopItem = function(name) {
  const item = shopItems.find(i=>i.name===name);
  if (hero.coins >= item.price) {
    hero.coins -= item.price;
    unlockItem(item.name);
    alert("You bought " + item.name + "!");
    localStorage.setItem('rpg-hero', JSON.stringify(hero));
    renderShopPage();
    renderInventoryPage();
    updateHeroDisplay();
  } else {
    alert("Not enough coins!");
  }
};

// ---- Stats/Trophies Page ----
function getStats() {
  let completed = questLog.filter(e=>e.type==="complete").length;
  let highestStreak = Math.max(0, ...habits.map(h=>h.streak||0));
  let totalXP = hero.level>1
    ? Array.from({length: hero.level-1}, (_,i)=>xpToNext(i+1)).reduce((a,b)=>a+b,0) + hero.xp
    : hero.xp;
  let totalQuests = habits.length;
  let pets = hero.items.filter(i=>["Dog Pet","Cat Pet","Bunny Pet"].includes(i)).length;
  return {completed, highestStreak, totalXP, totalQuests, pets};
}
function renderStatsPage() {
  const st = getStats();
  document.getElementById('stats-content').innerHTML = `
    <div class="stat-label">Total Quests Completed:</div> <b>${st.completed}</b>
    <div class="stat-label">Current Quests:</div> <b>${st.totalQuests}</b>
    <div class="stat-label">Highest Streak:</div> <b>${st.highestStreak}</b>
    <div class="stat-label">Total XP Earned:</div> <b>${st.totalXP}</b>
    <div class="stat-label">Coins Collected:</div> <b>${hero.coins||0}</b>
    <div class="stat-label">Pets Owned:</div> <b>${st.pets}</b>
  `;
}

// ---- Achievements Page ----
function renderAchievementsPage() {
  grantAchievements();
  const el = document.getElementById('achievements-list');
  el.innerHTML = allAchievements.map(ach => {
    const unlocked = hero.achievements.includes(ach.key);
    return `<div class="flex items-start gap-4 mb-4 ${unlocked?'achievement-unlocked':'achievement-locked'}">
      <div class="text-3xl mt-1"><i class="fas ${ach.icon}"></i></div>
      <div>
        <div class="font-bold">${ach.name}</div>
        <div class="text-sm mb-1">${ach.desc}</div>
        <div class="inline-block text-xs ${unlocked?'text-green-600':'text-gray-400'}">${unlocked?'Unlocked':'Locked'}</div>
        <span class="inline-block ml-2 px-2 py-1 rounded bg-yellow-100 dark:bg-yellow-900 text-yellow-900 dark:text-yellow-200 text-xs">${ach.bonus}</span>
      </div>
    </div>`;
  }).join("");
}

// ---- Quest Log ----
function addQuestLogEntry(type, name, data) {
  questLog.push({
    date: new Date().toLocaleString(),
    type, name, ...data
  });
  if (questLog.length>100) questLog.shift();
  localStorage.setItem('rpg-questlog', JSON.stringify(questLog));
}
function renderQuestLogPage() {
  const ql = document.getElementById("questlog-content");
  if (!questLog.length) {
    ql.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400">No quest history yet. Complete quests to fill your log!</div>`;
    return;
  }
  ql.innerHTML = questLog.slice().reverse().map(ev=>{
    if (ev.type==="complete") {
      return `<div class="mb-2 flex items-center gap-2">
        <i class="fas fa-check-circle text-green-500"></i>
        <span class="font-bold">${ev.name}</span> completed (+${ev.xp}xp, streak ${ev.streak||1}) <span class="text-xs text-gray-400">${ev.date}</span>
      </div>`;
    }
    if (ev.type==="levelup") {
      return `<div class="mb-2 flex items-center gap-2">
        <i class="fas fa-star text-yellow-400"></i>
        <span class="font-bold">Level Up!</span> Level ${ev.level} at ${ev.date}
      </div>`;
    }
    if (ev.type==="daily") {
      return `<div class="mb-2 flex items-center gap-2">
        <i class="fas fa-calendar-day text-pink-400"></i>
        <span class="font-bold">Daily Login Reward</span> (+${ev.xp}xp, +${ev.coins} coins) <span class="text-xs text-gray-400">${ev.date}</span>
      </div>`;
    }
    return "";
  }).join("");
}

// ---- XP, Level, Coins ----
function updateHeroDisplay() {
  document.getElementById('hero-level').textContent = hero.level;
  document.getElementById('hero-xp').textContent = `${hero.xp}/${xpToNext(hero.level)}`;
  document.getElementById('coins').innerHTML = `<i class="fas fa-coins"></i> ${hero.coins||0}`;
  let percent = Math.min(100, Math.round((hero.xp / xpToNext(hero.level))*100));
  document.getElementById('xp-bar').style.width = percent + "%";
}
function gainXP(amount) {
  hero.xp += amount;
  let leveled = false;
  while (hero.xp >= xpToNext(hero.level)) {
    hero.xp -= xpToNext(hero.level);
    hero.level += 1;
    leveled = true;
  }
  localStorage.setItem('rpg-hero', JSON.stringify(hero));
  updateHeroDisplay();
  if (leveled) {
    document.getElementById('levelup-badge').classList.remove('hidden');
    document.querySelector('.rpg-avatar').classList.add('level-up');
    showConfetti();
    playSound("audio-levelup");
    addQuestLogEntry("levelup", "Level Up", {level: hero.level});
    setTimeout(()=>{
      document.getElementById('levelup-badge').classList.add('hidden');
      document.querySelector('.rpg-avatar').classList.remove('level-up');
    }, 1800);
  }
}
function gainCoins(amount) {
  hero.coins = (hero.coins || 0) + amount;
  localStorage.setItem('rpg-hero', JSON.stringify(hero));
  updateHeroDisplay();
}

// ---- Sound/Confetti ----
function showConfetti() {
  const confetti = document.getElementById('confetti');
  confetti.innerHTML = "";
  confetti.classList.remove('hidden');
  const colors = ['#4ade80', '#6366f1', '#7c3aed', '#fbbf24', '#f472b6', '#f87171', '#facc15'];
  for (let i=0; i<32; i++) {
    let el = document.createElement('div');
    el.className = "confetti-piece";
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.left = (5 + Math.random()*90) + "vw";
    el.style.top = (Math.random()*10) + "vh";
    el.style.transform = `rotate(${Math.random()*360}deg)`;
    confetti.appendChild(el);
  }
  setTimeout(()=>{ confetti.classList.add('hidden'); }, 1300);
}
function playSound(id) {
  if(localStorage.getItem('sound-on') === "false") return;
  try {
    const el = document.getElementById(id);
    el.currentTime = 0;
    el.play();
  } catch(e){}
}

// ---- Quests/Habits ----
function updateHabitProgress(idx, delta) {
  let h = habits[idx];
  if (!h.progress || h.lastDate !== todayISO()) {
    h.progress = 0; h.lastDate = todayISO();
  }
  h.progress = Math.max(0, h.progress + delta);
  if (h.progress === h.goal && !h.completedToday) {
    h.streak = (h.streak || 0) + 1;
    h.completedToday = true;
    gainXP(xpPerHabit + 5 * h.streak);
    gainCoins(3 + h.streak); // Earn coins on completion
    addQuestLogEntry("complete", h.name, {xp: xpPerHabit + 5 * h.streak, streak: h.streak});
    playSound("audio-quest");
    // Pet leveling: every 7 streaks, pet levels up!
    if (equipped.pet && h.streak>0 && h.streak % 7 === 0) {
      alert(`Your pet leveled up! Streak: ${h.streak}`);
    }
    // One-time quest auto remove
    if (h.kind === 'one-time') {
      habits.splice(idx,1);
    }
  } else if (h.progress < h.goal) {
    h.completedToday = false;
  }
  localStorage.setItem('rpg-habits', JSON.stringify(habits));
  renderHabits();
  grantAchievements();
  renderInventoryPage();
  renderAchievementsPage();
  renderAvatar();
  renderQuestLogPage();
}
function renderHabits() {
  const habitsList = document.getElementById('habits-list');
  habitsList.innerHTML = "";
  habits.forEach((habit, idx) => {
    if (habit.lastDate !== todayISO()) { habit.progress = 0; habit.completedToday = false; habit.lastDate=todayISO();}
    const percent = Math.min(100, Math.round(((habit.progress||0) / habit.goal) * 100));
    let typeColor = {
      mind: "from-blue-200 to-blue-500 dark:from-blue-900 dark:to-blue-800",
      body: "from-green-200 to-green-500 dark:from-green-900 dark:to-green-800",
      other: "from-yellow-200 to-yellow-500 dark:from-yellow-900 dark:to-yellow-800"
    }[habit.type] || "from-indigo-200 to-indigo-500";
    let kindLabel = habit.kind ? ` <span class="ml-2 px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">${habit.kind.replace("-"," ").toUpperCase()}</span>` : "";
    habitsList.innerHTML += `
    <div class="rpg-card bg-gradient-to-br ${typeColor} p-5 flex flex-col gap-2 md:flex-row items-center shadow-lg relative">
      <div class="text-4xl mr-4"><i class="fas ${habit.icon || 'fa-seedling'}"></i></div>
      <div class="flex-1">
        <div class="flex justify-between items-center">
          <span class="font-semibold text-lg">${habit.name}</span>
          <span class="rpg-quest">${habit.type[0].toUpperCase() + habit.type.slice(1)}${kindLabel}</span>
        </div>
        <div class="w-full bg-gradient-to-r from-gray-100 to-gray-300 dark:from-gray-700 dark:to-gray-800 rounded-full h-4 mt-2">
          <div class="rpg-xp-bar h-4 rounded-full rpg-glow" style="width:${percent}%"></div>
        </div>
        <div class="flex items-center gap-2 mt-2">
          <button class="bg-indigo-500 text-white px-2 py-1 rounded rpg-btn hover:bg-indigo-600" onclick="updateHabitProgress(${idx},1)"><i class="fas fa-plus"></i></button>
          <button class="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-2 py-1 rounded rpg-btn hover:bg-gray-400 dark:hover:bg-gray-600" onclick="updateHabitProgress(${idx},-1)"><i class="fas fa-minus"></i></button>
          <span class="ml-2 font-mono text-indigo-900 dark:text-indigo-200">${habit.progress||0} / ${habit.goal}</span>
          <span class="ml-4 text-xs">Streak: <span class="font-bold text-yellow-600 dark:text-yellow-300">${habit.streak||0}</span> <i class="fas fa-fire text-orange-400 animate-beat"></i></span>
          <button class="ml-4 text-xs text-yellow-600 dark:text-yellow-300 hover:underline" onclick="editHabit(${idx})" title="Edit Quest">
            <i class="fas fa-edit"></i>
          </button>
          <button class="ml-2 text-xs text-red-500 hover:underline" onclick="deleteHabit(${idx})" title="Delete Quest">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        ${habit.completedToday ? `<span class="inline-block mt-2 text-green-700 dark:text-green-300 font-bold text-xs"><i class="fas fa-check-circle"></i> Completed!</span>` : ""}
      </div>
    </div>`;
  });
}
window.updateHabitProgress = updateHabitProgress;
window.editHabit = function(idx) {
  const habit = habits[idx];
  document.getElementById('habit-name').value = habit.name;
  document.getElementById('habit-goal').value = habit.goal;
  document.getElementById('habit-type').value = habit.type;
  document.getElementById('habit-kind').value = habit.kind || "recurring";
  document.getElementById('habit-icon').value = habit.icon;
  habitModal.classList.remove('hidden');
  document.getElementById('modal-title').textContent = "Edit Quest";
  renderIconPicker(habit.icon);
  editingHabit = idx;
};
window.deleteHabit = function(idx) {
  if (confirm("Delete this quest? This cannot be undone.")) {
    habits.splice(idx, 1);
    localStorage.setItem('rpg-habits', JSON.stringify(habits));
    renderHabits();
    renderInventoryPage();
    renderAchievementsPage();
    renderQuestLogPage();
  }
};

// ---- Modal controls ----
const habitModal = document.getElementById('habit-modal');
document.getElementById('add-habit-btn').onclick = () => {
  editingHabit = null;
  habitModal.classList.remove('hidden');
  document.getElementById('habit-form').reset();
  document.getElementById('modal-title').textContent = "New Quest";
  document.getElementById('habit-icon').value = questIcons[0];
  renderIconPicker(questIcons[0]);
};
document.getElementById('close-modal').onclick = () => habitModal.classList.add('hidden');
document.getElementById('habit-form').onsubmit = function(e) {
  e.preventDefault();
  const name = document.getElementById('habit-name').value;
  const goal = parseInt(document.getElementById('habit-goal').value);
  const icon = document.getElementById('habit-icon').value || questIcons[0];
  const type = document.getElementById('habit-type').value;
  const kind = document.getElementById('habit-kind').value;
  if (editingHabit !== null) {
    habits[editingHabit] = { name, goal, icon, type, kind, progress: 0, streak: habits[editingHabit].streak||0, lastDate: todayISO(), completedToday: false };
    editingHabit = null;
  } else {
    habits.push({ name, goal, icon, type, kind, progress: 0, streak: 0, lastDate: todayISO(), completedToday: false });
  }
  localStorage.setItem('rpg-habits', JSON.stringify(habits));
  habitModal.classList.add('hidden');
  renderHabits();
  renderInventoryPage();
  renderAchievementsPage();
  renderAvatar();
  renderQuestLogPage();
  grantAchievements();
};

// ---- Settings Page ----
function renderSettingsPage() {
  document.getElementById('settings-name').value = hero.name || "Hero";
  document.getElementById('sound-toggle').checked = localStorage.getItem('sound-on') !== "false";
  document.getElementById('theme-select').value = localStorage.getItem('theme') || "system";
  // Avatar upload preview
  const custom = localStorage.getItem('custom-avatar');
  document.getElementById('avatar-upload-preview').innerHTML = custom ? `<img src="${custom}" style="height:42px;border-radius:7px;">` : "";
}
document.getElementById('settings-name').oninput = function(e) {
  hero.name = e.target.value;
  localStorage.setItem('rpg-hero', JSON.stringify(hero));
};
document.getElementById('sound-toggle').onchange = function(e) {
  localStorage.setItem('sound-on', e.target.checked);
};
document.getElementById('theme-select').onchange = function(e) {
  const t = e.target.value;
  localStorage.setItem('theme', t);
  document.documentElement.classList.toggle('dark', t==="dark");
  if(t==="system") document.documentElement.classList.toggle('dark', window.matchMedia("(prefers-color-scheme:dark)").matches);
};
// Avatar upload
document.getElementById('avatar-upload').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    localStorage.setItem('custom-avatar', evt.target.result);
    document.getElementById('avatar-upload-preview').innerHTML = `<img src="${evt.target.result}" style="height:42px;border-radius:7px;">`;
    renderAvatar();
  };
  reader.readAsDataURL(file);
};

// ---- Data Export/Import ----
function exportData() {
  const data = {
    hero, habits, questLog, equipped: JSON.parse(localStorage.getItem('rpg-equipped')||"{}")
  };
  const url = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'}));
  const a = document.createElement('a');
  a.href = url; a.download = 'HeroOfHabits-save.json'; a.click();
  URL.revokeObjectURL(url);
}
document.getElementById('import-data').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = JSON.parse(evt.target.result);
    localStorage.setItem('rpg-hero', JSON.stringify(data.hero));
    localStorage.setItem('rpg-habits', JSON.stringify(data.habits));
    localStorage.setItem('rpg-questlog', JSON.stringify(data.questLog));
    localStorage.setItem('rpg-equipped', JSON.stringify(data.equipped||{}));
    location.reload();
  };
  reader.readAsText(file);
};

// ---- Guided Onboarding ----
if (!localStorage.getItem('onboarded')) {
  document.getElementById('onboarding-modal').classList.remove('hidden');
}
document.getElementById('close-onboarding').onclick = function() {
  localStorage.setItem('onboarded', 'true');
  document.getElementById('onboarding-modal').classList.add('hidden');
};

// ---- Daily/Weekly Rewards ----
function grantDailyReward() {
  const lastLogin = localStorage.getItem("hoh-lastlogin") || "";
  const today = todayISO();
  if (lastLogin !== today) {
    gainXP(10);
    gainCoins(5);
    localStorage.setItem("hoh-lastlogin", today);
    addQuestLogEntry("daily", "Daily Login", {xp:10, coins:5});
    showConfetti();
    playSound("audio-levelup");
    alert("Daily reward: +10 XP, +5 coins!");
  }
}
grantDailyReward();

// ---- Dark mode toggle ----
const darkToggle = document.getElementById('dark-toggle');
darkToggle.addEventListener('click', () => {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? "dark" : "light");
});
(function() {
  let t = localStorage.getItem('theme');
  if (!t || t==="system") t = window.matchMedia("(prefers-color-scheme:dark)").matches ? "dark" : "light";
  document.documentElement.classList.toggle('dark', t==="dark");
})();

// ---- Local time in footer ----
const updateLocalTime = () => {
  document.getElementById('local-time').textContent = "Your local time: " + new Date().toLocaleString();
};
updateLocalTime(); setInterval(updateLocalTime, 60000);

// ---- On load ----
renderIconPicker(questIcons[0]);
updateHeroDisplay();
renderHabits();
renderAvatar();
renderInventoryPage();
renderAchievementsPage();
renderQuestLogPage();
renderShopPage();
renderStatsPage();
renderSettingsPage();
grantAchievements();
</script>
